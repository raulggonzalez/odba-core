/*! vdba-core - 0.6.0 (2014-12-26) */!function(){function Combinator(){}function Connection(config){Object.defineProperty(this,"config",{value:config,enumerable:!0})}function Database(){}function Driver(name){Object.defineProperty(this,"name",{value:name,enumerable:!0})}function Index(){}function Mapper(){}function Query(){}function Result(rows,options){Object.defineProperty(this,"rows",{value:rows}),Object.defineProperty(this,"options",{value:options||{}})}function ResultFilter(){}function Server(){}function Table(){}Combinator.prototype.join=function(source,target,sourceCol,targetCol,opts){var arrayAgg,res=[],util=vdba.util;arrayAgg=opts.arrayAgg;for(var i=0;i<source.length;++i){for(var srcRow=util._extend({},source[i]),arrAgg=srcRow[arrayAgg]=[],j=0;j<target.length;++j){var tgtRow=util._extend(target[j]);srcRow[sourceCol]==tgtRow[targetCol]&&arrAgg.push(tgtRow)}res.push(srcRow)}return res},Connection.prototype.clone=function(){throw new Error("Abstract method.")},Connection.prototype.__defineGetter__("connected",function(){throw new Error("Abstract property.")}),Connection.prototype.__defineGetter__("server",function(){throw new Error("Abstract property.")}),Connection.prototype.open=function(){throw new Error("Abstract method.")},Connection.prototype.close=function(){throw new Error("Abstract method.")},Connection.prototype.runTransaction=function(){throw new Error("Abstract method.")},Database.prototype.__defineGetter__("name",function(){throw new Error("Abstract property.")}),Database.prototype.hasTable=function(){throw new Error("Abstract method.")},Database.prototype.hasTables=function(){throw new Error("Abstract method.")},Database.prototype.findTable=function(){throw new Error("Abstract method.")},Database.prototype.createTable=function(){throw new Error("Abstract method.")},Database.prototype.createTables=function(){throw new Error("Abstract method.")},Database.prototype.dropTable=function(){throw new Error("Abstract method.")},Database.prototype.findIndex=function(){throw new Error("Abstract method.")},Database.prototype.hasIndex=function(){throw new Error("Abstract method.")},Database.prototype.createIndex=function(){throw new Error("Abstract method.")},Database.prototype.dropIndex=function(){throw new Error("Abstract method.")},Object.defineProperty(Driver,"cache",{value:{}}),Driver.getDriver=function(name){var cache=vdba.Driver.cache;if(!name)throw new Error("Driver name expected.");return cache[name.toLowerCase()]},Driver.register=function(driver,alias){var cache=vdba.Driver.cache;if(!driver)throw new Error("Driver expected.");if(cache[driver.name.toLowerCase()]=driver,alias){"string"==typeof alias&&(alias=[alias]);for(var i=0;i<alias.length;++i)cache[alias[i].toLowerCase()]=driver}},Driver.prototype.createConnection=function(){throw new Error("Abstract method.")},Driver.prototype.openConnection=function(config,callback){var cx;if(!config)throw new Error("Configuration expected.");if(!callback)throw new Error("Callback expected.");cx=this.createConnection(config),cx.open(function(error){error?callback(error):callback(void 0,cx)})},Index.prototype.__defineGetter__("database",function(){throw new Error("Abstract property.")}),Index.prototype.__defineGetter__("table",function(){throw new Error("Abstract property.")}),Index.prototype.__defineGetter__("name",function(){throw new Error("Abstract property.")}),Index.prototype.__defineGetter__("unique",function(){throw new Error("Abstract property.")}),Mapper.prototype.map=function(map,rows){var res;return res=rows instanceof vdba.Result?this.mapResult(map,rows):this.mapRows(map,rows)},Mapper.prototype.mapRows=function(map,rows){for(var res=[],i=0;i<rows.length;++i)res.push(this.mapRow(map,rows[i]));return res},Mapper.prototype.mapResult=function(map,result){var res;res=new result.constructor([],result.options);for(var i=0;i<result.length;++i)res.rows.push(this.mapRow(map,result.rows[i]));return res},Mapper.prototype.mapRow=function(map,row){var instance;return instance=map instanceof Function?this.customMap(map,row):map instanceof Array?this.defaultMap({map:map},row):map instanceof Object?this.defaultMap(map,row):row},Mapper.prototype.defaultMap=function(map,row){var instance,Class,mapping;if(Class=map.clss||Object,mapping=map.map||{},"string"==typeof mapping&&(mapping=[mapping]),mapping instanceof Array){for(var aux={},i=0;i<mapping.length;++i){var field=mapping[i];aux[field.toLowerCase()]=field}mapping=aux}instance=Object.create(Class.prototype);for(var key in row)instance[mapping[key]||key]=row[key];return instance},Mapper.prototype.customMap=function(map,row){return map(row)},Query.prototype.findAll=function(){throw new Error("Abstract method.")},Query.prototype.mapAll=function(map,callback){if(!map)throw new Error("Map expected.");if(!callback)throw new Error("Callback expected.");this.findAll(function(error,result){error?callback(error):callback(void 0,(new vdba.Mapper).map(map,result))})},Query.prototype.find=function(){throw new Error("Abstract method.")},Query.prototype.map=function(map,filter,callback){if(!map)throw new Error("Map expected.");2==arguments.length&&(callback=arguments[1],filter=void 0),this.find(filter,function(error,result){error?callback(error):callback(void 0,(new vdba.Mapper).map(map,result))})},Query.prototype.findOne=function(){throw new Error("Abstract method.")},Query.prototype.mapOne=function(){throw new Error("Abstract method.")},Query.prototype.join=function(){throw new Error("Abstract method.")},Result.prototype.__defineGetter__("length",function(){return this.rows.length}),Result.prototype.find=function(where){return(new vdba.ResultFilter).find(this,where)},Result.prototype.map=function(map,where){return(new vdba.Mapper).map(map,this.find(where))},ResultFilter.prototype.find=function(result,filter){var filtered=[];filter||(filter={});for(var i=0,rows=result.rows;i<result.length;++i){var row=rows[i];this.check(row,filter)&&filtered.push(row)}return filtered},ResultFilter.prototype.check=function(row,filter){var res=!1,keys=Object.keys(filter);if(0===keys.length)res=!0;else if(1==keys.length)res=this.checkProp(row,keys[0],filter);else{res=!0;for(var i=0,props=keys;i<props.length;++i){var prop=props[i];if(!this.checkProp(row,prop,filter)){res=!1;break}}}return res},ResultFilter.prototype.checkProp=function(row,prop,filter){var res;if(filter=filter[prop],"object"!=typeof filter)res=this.$eq(row,prop,filter);else{var ops=Object.keys(filter);if(0===ops.length)res=!0;else if(1==ops.length)res=this.checkOp(row,prop,ops[0],filter);else{res=!0;for(var i=0;i<ops.length;++i)if(!this.checkOp(row,prop,ops[i],filter)){res=!1;break}}}return res},ResultFilter.prototype.checkOp=function(row,prop,op,filter){var res;if("$eq"==op)res=this.$eq(row,prop,filter.$eq);else if("$ne"==op)res=this.$ne(row,prop,filter.$ne);else if("$lt"==op)res=this.$lt(row,prop,filter.$lt);else if("$le"==op)res=this.$le(row,prop,filter.$le);else if("$gt"==op)res=this.$gt(row,prop,filter.$gt);else if("$ge"==op)res=this.$ge(row,prop,filter.$ge);else if("$like"==op)res=this.$like(row,prop,filter.$like);else if("$notLike"==op)res=this.$notLike(row,prop,filter.$notLike);else if("$in"==op)res=this.$in(row,prop,filter.$in);else{if("$notIn"!=op)throw new Error("Unknown operator: '"+op+"'.");res=this.$notIn(row,prop,filter.$notIn)}return res},ResultFilter.prototype.$eq=function(row,prop,value){return void 0===value?void 0===row[prop]:null===value?null===row[prop]:row[prop]==value},ResultFilter.prototype.$ne=function(row,prop,value){return void 0===value?void 0!==row[prop]:null===value?null!==row[prop]:row[prop]!=value},ResultFilter.prototype.$lt=function(row,prop,value){return void 0===value||null===value?!1:row[prop]<value},ResultFilter.prototype.$le=function(row,prop,value){return void 0===value||null===value?!1:row[prop]<=value},ResultFilter.prototype.$gt=function(row,prop,value){return void 0===value||null===value?!1:row[prop]>value},ResultFilter.prototype.$ge=function(row,prop,value){return void 0===value||null===value?!1:row[prop]>=value},ResultFilter.prototype.$like=function(row,prop,value){return void 0===value||null===value?this.$eq(row,prop,value):new RegExp(value).test(row[prop])},ResultFilter.prototype.$notLike=function(row,prop,value){return void 0===value||null===value?this.$ne(row,prop,value):!this.$like(row,prop,value)},ResultFilter.prototype.$in=function(row,prop,value){return void 0===value||null===value?!1:value.indexOf(row[prop])>=0},ResultFilter.prototype.$notIn=function(row,prop,value){return!this.$in(row,prop,value)},Server.prototype.__defineGetter__("host",function(){throw new Error("Abstract method.")}),Server.prototype.__defineGetter__("port",function(){throw new Error("Abstract method.")}),Server.prototype.__defineGetter__("version",function(){throw new Error("Abstract method.")}),Server.prototype.createDatabase=function(){throw new Error("Abstract method.")},Server.prototype.hasDatabase=function(){throw new Error("Abstract method.")},Server.prototype.dropDatabase=function(){throw new Error("Abstract method.")},Table.prototype.__defineGetter__("database",function(){throw new Error("Abstract method.")}),Table.prototype.__defineGetter__("name",function(){throw new Error("Abstract method.")}),Table.prototype.hasIndex=function(name,callback){if(!name)throw new Error("Index name expected.");if(!callback)throw new Error("Callback expected.");this.database.hasIndex(this.name,name,callback)},Table.prototype.findIndex=function(name,callback){if(arguments.length<2)throw new Error("Index name and callback expected.");this.database.findIndex(this.name,name,callback)},Table.prototype.createIndex=function(name,col,options,callback){if(arguments.length<2)throw new Error("Index name and indexing column expected.");3==arguments.length&&arguments[2]instanceof Function&&(callback=arguments[2],options={}),this.database.createIndex(this.name,name,col,options,callback)},Table.prototype.dropIndex=function(name,callback){if(arguments.length<1)throw new Error("Index name expected.");this.database.dropIndex(this.name,name,callback)},Table.prototype.query=function(){throw new Error("Abstract method.")},Table.prototype.find=function(filter,callback){if(1==arguments.length&&(callback=arguments[0],filter=void 0),!callback)throw new Error("Callback expected.");this.query().find(filter,callback)},Table.prototype.map=function(map,filter,callback){if(2==arguments.length&&(callback=arguments[1],filter=void 0),!map)throw new Error("Map expected.");if(!callback)throw new Error("Callback expected.");this.query().map(map,filter,callback)},Table.prototype.findAll=function(callback){if(!callback)throw new Error("Callback expected.");this.query().find(callback)},Table.prototype.mapAll=function(map,callback){if(!map)throw new Error("Map expected.");if(!callback)throw new Error("Callback expected.");this.query().mapAll(map,callback)},Table.prototype.findOne=function(filter,callback){1==arguments.length&&(callback=arguments[0],filter=void 0),this.query().findOne(filter,callback)},Table.prototype.mapOne=function(map,filter,callback){if(2==arguments.length&&(callback=arguments[1],filter=void 0),!map)throw new Error("Map expected.");if(!callback)throw new Error("Callback expected.");this.query().mapOne(map,filter,callback)},Table.prototype.count=function(){throw new Error("Abstract method.")},Table.prototype.join=function(target,col1,col2,callback){if(3==arguments.length&&arguments[2]instanceof Function&&(callback=arguments[2],col2=void 0),col2||(col2=col1),!target)throw new Error("Target table expected.");if(!col1)throw new Error("Source column expected.");if(!col2)throw new Error("Target column expected.");return callback?void this.query().join(target,col1,col2,callback):this.query().join(target,col1,col2)},Table.prototype.insert=function(){throw new Error("Abstract method.")},Table.prototype.save=function(){throw new Error("Abstract method.")},Table.prototype.update=function(){throw new Error("Abstract method.")},Table.prototype.remove=function(){throw new Error("Abstract method.")};var util=require("util"),vdba=module.exports;Object.defineProperty(vdba,"util",{value:{inherits:util.inherits,_extend:util._extend}}),Object.defineProperty(vdba,"Combinator",{value:Combinator,enumerable:!0}),Object.defineProperty(vdba,"Connection",{value:Connection,enumerable:!0}),Object.defineProperty(vdba,"Database",{value:Database,enumerable:!0}),Object.defineProperty(vdba,"Driver",{value:Driver,enumerable:!0}),Object.defineProperty(vdba,"Index",{value:Index,enumerable:!0}),Object.defineProperty(vdba,"Mapper",{value:Mapper,enumerable:!0}),Object.defineProperty(vdba,"Query",{value:Query,enumerable:!0}),Object.defineProperty(vdba,"Result",{value:Result,enumerable:!0}),Object.defineProperty(vdba,"ResultFilter",{value:ResultFilter,enumerable:!0}),Object.defineProperty(vdba,"Server",{value:Server,enumerable:!0}),Object.defineProperty(vdba,"Table",{value:Table,enumerable:!0})}();